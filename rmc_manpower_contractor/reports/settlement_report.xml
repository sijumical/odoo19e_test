<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <report
            id="action_rmc_agreement_settlement_report"
            string="Agreement Settlement"
            model="rmc.agreement.settlement.wizard"
            report_type="qweb-pdf"
            name="rmc_manpower_contractor.report_agreement_settlement"
            file="rmc_manpower_contractor.report_agreement_settlement"
            print_report_name="'Settlement - %s' % (object.agreement_id.name,)"/>

        <template id="report_agreement_settlement">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.external_layout">
                    <div class="page">
                    <h2>Agreement Settlement Summary</h2>
                    <p>
                        <strong>Agreement:</strong>
                        <span t-esc="doc.agreement_id.display_name"/>
                    </p>
                    <p>
                        <strong>Contractor:</strong>
                        <span t-esc="doc.contractor_id.display_name"/>
                    </p>
                    <p>
                        <strong>Period:</strong>
                        <span t-esc="doc.period_start"/> â†’ <span t-esc="doc.period_end"/>
                    </p>
                    <h3>Performance Snapshot</h3>
                    <table class="table table-sm">
                        <tr>
                            <th>MGQ Target</th>
                            <td t-esc="doc.mgq_target"/>
                            <th>Actual</th>
                            <td t-esc="doc.mgq_actual_qty"/>
                            <th>MGQ Achieved</th>
                            <td>
                                <span t-esc="doc.mgq_achieved and 'Yes' or 'No'"/>
                            </td>
                        </tr>
                        <tr>
                            <th>Variable Pay</th>
                            <td t-esc="doc.variable_pay_amount"/>
                            <th>Breakdown Deductions</th>
                            <td t-esc="doc.breakdown_deduction_total"/>
                            <th>Inventory Variance</th>
                            <td t-esc="doc.inventory_variance_total"/>
                        </tr>
                        <tr>
                            <th>Damage Charges</th>
                            <td t-esc="doc.damage_cost_total"/>
                            <th>Open Bills</th>
                            <td t-esc="doc.open_bills_total"/>
                            <th>Final Payable</th>
                            <td t-esc="doc.final_payable_amount"/>
                        </tr>
                    </table>
                    <h3>Breakdown Events</h3>
                    <table class="table table-sm">
                        <tr>
                            <th>Reference</th>
                            <th>Downtime (Hr)</th>
                            <th>Deduction</th>
                        </tr>
                        <t t-foreach="doc.breakdown_event_ids" t-as="event">
                            <tr>
                                <td t-esc="event.display_name"/>
                                <td t-esc="event.downtime_hr"/>
                                <td t-esc="event.deduction_amount"/>
                            </tr>
                        </t>
                        <tr t-if="not doc.breakdown_event_ids">
                            <td colspan="3">No breakdown events included.</td>
                        </tr>
                    </table>
                    <h3>Inventory Handover</h3>
                    <table class="table table-sm">
                        <tr>
                            <th>Item</th>
                            <th>Variance Qty</th>
                            <th>Variance Value</th>
                            <th>Damage Cost</th>
                        </tr>
                        <t t-foreach="doc.inventory_handover_ids" t-as="handover">
                            <tr>
                                <td t-esc="handover.item_id.display_name"/>
                                <td t-esc="handover.variance_qty"/>
                                <td t-esc="handover.variance_value"/>
                                <td t-esc="handover.damage_cost"/>
                            </tr>
                        </t>
                        <tr t-if="not doc.inventory_handover_ids">
                            <td colspan="4">No inventory variances pending.</td>
                        </tr>
                    </table>
                    <h3>Open Bills</h3>
                    <table class="table table-sm">
                        <tr>
                            <th>Bill</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                        <t t-foreach="doc.open_bill_ids" t-as="bill">
                            <tr>
                                <td t-esc="bill.display_name"/>
                                <td t-esc="bill.amount_residual"/>
                                <td t-esc="bill.payment_state"/>
                            </tr>
                        </t>
                        <tr t-if="not doc.open_bill_ids">
                            <td colspan="3">No pending bills.</td>
                        </tr>
                    </table>
                    <p>
                        <strong>Proposed Action:</strong>
                        <span t-esc="doc.proposed_action_label"/>
                    </p>
                        <p>
                            <strong>Notes:</strong>
                            <span t-esc="doc.notes"/>
                        </p>
                    </div>
                </t>
            </t>
        </template>
    </data>
</odoo>
